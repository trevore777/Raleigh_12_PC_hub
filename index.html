<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rayleigh 12 PC AI Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary: #1e3a8a;
      --primary-light: #3b82f6;
      --bg: #020617;
      --card-bg: #0b1220;
      --accent: #facc15;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 55%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 1rem;
    }

    .app {
      width: 100%;
      max-width: 900px;
      margin: auto;
    }

    header {
      text-align: center;
      margin-bottom: 1.2rem;
    }

    header h1 {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    header p {
      margin-top: 0.25rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .card {
      background: rgba(11, 18, 32, 0.96);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.9);
      padding: 1rem 1.1rem 1.1rem;
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.6rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
    }

    .small-caps {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.35rem;
    }

    textarea {
      width: 100%;
      min-height: 70px;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 0.85rem;
      padding: 0.5rem 0.6rem;
      resize: vertical;
      margin-top: 0.35rem;
    }

    textarea::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin: 0.45rem 0 0.5rem;
    }

    .pill {
      font-size: 0.72rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.5rem 0.9rem;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.6);
    }

    button:disabled {
      opacity: 0.6;
      cursor: wait;
      box-shadow: none;
    }

    .outline-btn {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.8);
      box-shadow: none;
      color: var(--text-main);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .ai-output {
      margin-top: 0.6rem;
      padding: 0.6rem 0.65rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      min-height: 80px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 0.9rem;
      line-height: 1.45;
      white-space: pre-line;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .toggle-row label {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }

    input[type="checkbox"] {
      width: 15px;
      height: 15px;
      accent-color: var(--primary-light);
      cursor: pointer;
    }

    .music-frame {
      border-radius: 0.85rem;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.5);
      margin-top: 0.6rem;
    }

    iframe {
      width: 100%;
      border: 0;
    }

    .footer-note {
      text-align: center;
      margin-top: 0.9rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .footer-note span {
      color: var(--accent);
    }

    /* Time + weather */
    .clock-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .clock-main {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1.9rem;
      font-weight: 600;
      letter-spacing: 0.08em;
    }

    .clock-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .weather-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
      width: 100%;
    }

    .weather-slot {
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 0.4rem 0.45rem;
      font-size: 0.78rem;
      background: rgba(15, 23, 42, 0.9);
    }

    .weather-time {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .weather-temp {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .weather-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .weather-error {
      font-size: 0.75rem;
      color: var(--danger);
      margin-top: 0.3rem;
    }

    @media (max-width: 500px) {
      .clock-main {
        font-size: 1.5rem;
      }
      .weather-grid {
        gap: 0.35rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Rayleigh 12 PC AI Hub</h1>
      <p>10-minute Pastoral Care assistant ¬∑ Christian, age-appropriate content</p>
    </header>

    <!-- Time + Weather card -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">üïí Time & Weather ‚Äì Rayleigh / Reedy Creek</div>
        <span class="badge">Today</span>
      </div>
      <div class="card-body">
        <div class="clock-row">
          <div>
            <div class="clock-main" id="digital-clock">--:--</div>
            <div class="clock-label" id="clock-date"></div>
          </div>
          <div>
            <span class="small-caps">Forecast slots</span>
            <div class="weather-grid">
              <div class="weather-slot" id="wx-9">
                <div class="weather-time">9:00am</div>
                <div class="weather-temp" data-temp>--¬∞C</div>
                <div class="weather-desc" data-desc>Loading‚Ä¶</div>
              </div>
              <div class="weather-slot" id="wx-12">
                <div class="weather-time">12:00pm</div>
                <div class="weather-temp" data-temp>--¬∞C</div>
                <div class="weather-desc" data-desc>Loading‚Ä¶</div>
              </div>
              <div class="weather-slot" id="wx-15">
                <div class="weather-time">3:00pm</div>
                <div class="weather-temp" data-temp>--¬∞C</div>
                <div class="weather-desc" data-desc>Loading‚Ä¶</div>
              </div>
            </div>
          </div>
        </div>
        <div id="weather-error" class="weather-error"></div>
      </div>
    </section>

    <!-- AI PC Assistant -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">ü§ñ AI PC Assistant</div>
        <span class="badge">Teacher only</span>
      </div>

      <div class="card-body">
        <p class="small-caps">Context for today (optional)</p>
        <textarea
          id="context-input"
          placeholder="e.g. Stress before exams, friendships, gratitude, or paste a Bible verse here‚Ä¶"
        ></textarea>

        <div class="pill-row">
          <div class="pill">Year level: 12</div>
          <div class="pill">Rayleigh PC</div>
          <div class="pill">Christian school</div>
          <div class="pill">Approx. 10 minutes</div>
        </div>

        <p class="small-caps">Generate</p>
        <div class="button-row">
          <button type="button" class="outline-btn" id="btn-prayer" onclick="generateFromAI('prayer')">
            üïä Prayer
          </button>
          <button type="button" class="outline-btn" id="btn-devotional" onclick="generateFromAI('devotional')">
            üìñ Devotional
          </button>
          <button type="button" class="outline-btn" id="btn-questions" onclick="generateFromAI('questions')">
            üí¨ Discussion Qs
          </button>
          <button type="button" class="outline-btn" id="btn-game" onclick="generateFromAI('game')">
            üé≤ Community game
          </button>
        </div>

        <div class="toggle-row">
          <label>
            <input type="checkbox" id="short-mode" checked />
            Prefer short answers (readable in &lt; 2 minutes)
          </label>
          <span>Content: Christian, safe, teacher-led</span>
        </div>

        <div class="ai-output" id="ai-output">
          AI output will appear here. Use it live with the class or copy into Compass.
        </div>

        <p class="hint">
          Tip: Type a quick theme (‚Äúgratitude‚Äù, ‚Äúfriendship conflict‚Äù, ‚Äúupcoming exams‚Äù) before generating
          to tailor the prayer, devotional, questions, or game.
        </p>
      </div>
    </section>

    <!-- Music: Rayleigh playlist / song -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">üéµ Rayleigh PC Music</div>
        <span class="badge">Play in background</span>
      </div>
      <div class="card-body">
        <p class="small-caps">YouTube</p>
        <p>Tap play and let this run quietly during silent reflection or while students settle.</p>
        <div class="music-frame">
          <iframe
            src="https://www.youtube.com/embed/evYZdxlwGhA"
            title="Rayleigh PC Music"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
          ></iframe>
        </div>
      </div>
    </section>

    <p class="footer-note">
      <span>AI content</span> powered via OpenAI (server-side key on Vercel).  
      Designed for Rayleigh 12 Pastoral Care sessions.
    </p>
  </div>

  <script>
    // ---------- Digital clock ----------
    function pad2(n) {
      return n.toString().padStart(2, "0");
    }

    function updateClock() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();

      const clockEl = document.getElementById("digital-clock");
      const dateEl = document.getElementById("clock-date");

      // 24h -> 12h display
      const displayHour = ((hours + 11) % 12) + 1;
      const ampm = hours >= 12 ? "pm" : "am";

      clockEl.textContent = `${pad2(displayHour)}:${pad2(minutes)}:${pad2(seconds)} ${ampm}`;

      const weekdays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
      const dayName = weekdays[now.getDay()];
      const day = now.getDate();
      const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const month = monthNames[now.getMonth()];
      dateEl.textContent = `${dayName} ¬∑ ${day} ${month}`;
    }

    // ---------- Weather (Open-Meteo, no key required) ----------
    // Coords roughly for Reedy Creek / Gold Coast region
    const LAT = -28.11;
    const LON = 153.41;

    function mapWeatherCode(code) {
      // Simplified mapping
      if (code === 0) return "Clear sky";
      if ([1, 2].includes(code)) return "Mostly clear";
      if (code === 3) return "Cloudy";
      if ([45, 48].includes(code)) return "Fog / mist";
      if ([51, 53, 55].includes(code)) return "Light drizzle";
      if ([61, 63].includes(code)) return "Rain showers";
      if (code === 65) return "Heavy rain";
      if ([71, 73, 75].includes(code)) return "Snow";
      if ([80, 81, 82].includes(code)) return "Showers";
      if ([95, 96, 99].includes(code)) return "Storms";
      return "Mixed conditions";
    }

    async function loadWeather() {
      const errorEl = document.getElementById("weather-error");
      errorEl.textContent = "";

      try {
        // Request hourly forecast for today in local (Australia/Brisbane) time
        const url =
          "https://api.open-meteo.com/v1/forecast" +
          `?latitude=${LAT}&longitude=${LON}` +
          "&hourly=temperature_2m,weathercode" +
          "&timezone=Australia%2FBrisbane";

        const res = await fetch(url);
        if (!res.ok) {
          errorEl.textContent = "Unable to load weather.";
          return;
        }

        const data = await res.json();
        const times = data.hourly?.time || [];
        const temps = data.hourly?.temperature_2m || [];
        const codes = data.hourly?.weathercode || [];

        if (!times.length) {
          errorEl.textContent = "No weather data available.";
          return;
        }

        // Find today's date string from first time entry
        const todayStr = times[0].slice(0, 10); // "YYYY-MM-DD"

        const targetHours = { 9: "wx-9", 12: "wx-12", 15: "wx-15" };

        Object.entries(targetHours).forEach(([hour, elemId]) => {
          const target = `${todayStr}T${hour.padStart ? hour.padStart(2, "0") : ("0" + hour).slice(-2)}:00`;
          const idx = times.indexOf(target);
          const slotEl = document.getElementById(elemId);
          if (!slotEl) return;

          const tempEl = slotEl.querySelector("[data-temp]");
          const descEl = slotEl.querySelector("[data-desc]");

          if (idx === -1) {
            tempEl.textContent = "--¬∞C";
            descEl.textContent = "No data";
          } else {
            const temp = Math.round(temps[idx]);
            const code = codes[idx];
            tempEl.textContent = `${temp}¬∞C`;
            descEl.textContent = mapWeatherCode(code);
          }
        });
      } catch (err) {
        console.error(err);
        errorEl.textContent = "Weather error.";
      }
    }

    // ---------- AI calls (to your Vercel function using openAPIkey env) ----------
    async function generateFromAI(type) {
      const shortMode = document.getElementById("short-mode").checked;
      const contextInput = document.getElementById("context-input");
      const outputEl = document.getElementById("ai-output");

      const buttons = [
        "btn-prayer",
        "btn-devotional",
        "btn-questions",
        "btn-game"
      ].map(id => document.getElementById(id));

      buttons.forEach(btn => btn.disabled = true);
      outputEl.textContent = "Thinking‚Ä¶ (generating " + type + ")";

      const verseText = contextInput.value || "";

      try {
        const res = await fetch("/api/pc-ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type, verseText, shortMode })
        });

        const data = await res.json();
        if (!res.ok) {
          outputEl.textContent = "Error from server: " + (data.error || res.statusText);
        } else {
          outputEl.textContent = data.text || "No text returned.";
        }
      } catch (err) {
        console.error(err);
        outputEl.textContent = "Network or server error: " + err.message;
      } finally {
        buttons.forEach(btn => btn.disabled = false);
      }
    }

    // ---------- Init ----------
    document.addEventListener("DOMContentLoaded", () => {
      updateClock();
      setInterval(updateClock, 1000); // update every second
      loadWeather();
    });
  </script>
</body>
</html>
